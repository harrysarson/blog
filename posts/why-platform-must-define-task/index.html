<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Why Platform Must Define Task - Harry Sarson's Thoughts</title><meta name=description content="span:before { display: block; position: absolute; content: &#34; &#34;; margin-top: -285px; height: 285px; visibility: hidden; pointer-events: none; }  Why Platform must define Task  The examples in this post uses elm 0.19.1 and elm/core 1.0.2.
 I have been investing the runtime of the elm programming language, mainly to see if it is possible to write more of the logic of the runtime in elm code, rather than in JavaScript &ldquo;kernel code&rdquo;."><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Harry Sarson\u0027s Thoughts","url":"https:\/\/harrysarson.github.io\/blog\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/harrysarson.github.io\/blog\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/harrysarson.github.io\/blog\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/harrysarson.github.io\/blog\/posts\/why-platform-must-define-task\/","name":"Why platform must define task"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Why Platform Must Define Task","description":"span:before { display: block; position: absolute; content: \u0022 \u0022; margin-top: -285px; height: 285px; visibility: hidden; pointer-events: none; }  Why Platform must define Task  The examples in this post uses elm 0.19.1 and elm\/core 1.0.2.\n I have been investing the runtime of the elm programming language, mainly to see if it is possible to write more of the logic of the runtime in elm code, rather than in JavaScript \u0026ldquo;kernel code\u0026rdquo;.","inLanguage":"en","wordCount":508,"datePublished":"2019-11-21T20:00:00","dateModified":"2019-11-21T20:00:00","image":"https:\/\/harrysarson.github.io\/blog\/","keywords":[""],"mainEntityOfPage":"https:\/\/harrysarson.github.io\/blog\/posts\/why-platform-must-define-task\/","publisher":{"@type":"Organization","name":"https:\/\/harrysarson.github.io\/blog\/","logo":{"@type":"ImageObject","url":"https:\/\/harrysarson.github.io\/blog\/","height":60,"width":60}}}</script><meta property="og:title" content="Why Platform Must Define Task"><meta property="og:description" content="span:before { display: block; position: absolute; content: &#34; &#34;; margin-top: -285px; height: 285px; visibility: hidden; pointer-events: none; }  Why Platform must define Task  The examples in this post uses elm 0.19.1 and elm/core 1.0.2.
 I have been investing the runtime of the elm programming language, mainly to see if it is possible to write more of the logic of the runtime in elm code, rather than in JavaScript &ldquo;kernel code&rdquo;."><meta property="og:url" content="https://harrysarson.github.io/blog/posts/why-platform-must-define-task/"><meta property="og:type" content="website"><meta property="og:site_name" content="Harry Sarson's Thoughts"><meta name=twitter:title content="Why Platform Must Define Task"><meta name=twitter:description content="span:before { display: block; position: absolute; content: &#34; &#34;; margin-top: -285px; height: 285px; visibility: hidden; pointer-events: none; }  Why Platform must define Task  The examples in this post …"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.71.1"><link rel=alternate href=https://harrysarson.github.io/blog/index.xml type=application/rss+xml title="Harry Sarson's Thoughts"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://harrysarson.github.io/blog/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://harrysarson.github.io/blog/css/syntax.css><link rel=stylesheet href=https://harrysarson.github.io/blog/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://harrysarson.github.io/blog/>Harry Sarson's Thoughts</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Why Platform Must Define Task</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><style>span:before{display:block;position:absolute;content:" ";margin-top:-285px;height:285px;visibility:hidden;pointer-events:none}</style><h1 id=why-platform-must-define-task>Why <code>Platform</code> must define <code>Task</code></h1><blockquote><p>The examples in this post uses <code>elm 0.19.1</code> and <code>elm/core 1.0.2</code>.</p></blockquote><p>I have been investing the runtime of the <a href=https://elm-lang.org>elm programming language</a>, mainly to see if it is possible to write more of the logic of the runtime in elm code, rather than in JavaScript &ldquo;kernel code&rdquo;.
As part of this investigation I replaced the definition of the <code>Task</code> type documented <a href=https://package.elm-lang.org/packages/elm/core/latest/Task>here</a> and <a href=https://package.elm-lang.org/packages/elm/core/latest/Platform#Task>here</a>.
Currently, the <code>Platform</code> module defiens the <code>Task</code> type as follows</p><div class=highlight><pre class=chroma><code class=language-elm data-lang=elm><span class=kr>type</span> <span class=kt>Task</span> <span class=nv>err</span> <span class=nv>ok</span> <span class=nf>=</span> <span class=kt>Task</span>
</code></pre></div><p><span id=a1></span>This is possibly the most important type in the elm runtime and yet, as far as elm code can tell, contains no data.
This is a stub definition, elm&rsquo;s typechecker can use it to verify that elm code using <code>Task</code>s is written correctly <a href=#f1>[1]</a>.
<span id=a2></span></p><p>My goal is to create a runtime for elm mostly written in elm, and so the definition of the <code>Task</code> type seemed a good place to start.
After much iteration <a href=#f2>[2]</a> I settled on the following definition of a <code>Task</code> which I placed in a new module <code>Platform.Scheduler</code>.</p><div class=highlight><pre class=chroma><code class=language-elm data-lang=elm><span class=kn>module </span><span class=nc>Platform.Scheduler</span> <span class=nv>exposing</span> <span class=p>(</span><span class=kt>Task</span><span class=nf>(..)</span><span class=p>,</span> <span class=kt>DoneCallback</span><span class=p>,</span> <span class=kt>TryAbortAction</span><span class=p>)</span>

<span class=kr>type</span> <span class=kt>Task</span> <span class=nv>val</span>
    <span class=nf>=</span> <span class=kt>Value</span> <span class=nv>val</span>
    <span class=nf>|</span> <span class=kt>AndThen</span> <span class=p>(</span><span class=kt>HiddenVal</span> <span class=nf>-&gt;</span> <span class=kt>Task</span> <span class=nv>val</span><span class=p>)</span> <span class=p>(</span><span class=kt>Task</span> <span class=kt>HiddenVal</span><span class=p>)</span>
    <span class=nf>|</span> <span class=kt>AsyncAction</span> <span class=p>(</span><span class=kt>DoneCallback</span> <span class=nf>-&gt;</span> <span class=kt>TryAbortAction</span><span class=p>)</span> <span class=kt>TryAbortAction</span>


<span class=kr>type</span> <span class=kt>HiddenVal</span>
    <span class=nf>=</span> <span class=kt>HiddenVal</span> <span class=kt>Never</span>


<span class=kr>type</span> <span class=kr>alias</span> <span class=kt>DoneCallback</span> <span class=nf>=</span>
    <span class=kt>Task</span> <span class=nv>val</span> <span class=nf>-&gt;</span> <span class=p>()</span>


<span class=kr>type</span> <span class=kr>alias</span> <span class=kt>TryAbortAction</span> <span class=nf>=</span>
    <span class=p>()</span> <span class=nf>-&gt;</span> <span class=p>()</span>
</code></pre></div><p>Two details of this definition are worth noting:</p><ol><li>The <code>HiddenVal</code> type allows me to write down the definition of the <code>Task</code> type which would be immposible to do in elm code.
I will need to use a kernel function to convert values of some generic type <code>a</code> into <code>HiddenVal</code> in the body of the <code>Task.andThen</code> function.</li><li>There is only one type parameter.
This simplifies the defintion and the implemention of <code>Task</code> related functions.</li></ol><p>I can then define the <code>Platform.Task</code> type as an alias to this definition.</p><div class=highlight><pre class=chroma><code class=language-elm data-lang=elm><span class=kn>module </span><span class=nc>Platform</span> <span class=nv>exposing</span> <span class=p>(</span><span class=kt>Task</span><span class=p>,</span> <span class=nf>...</span><span class=p>)</span>

<span class=kn>import </span><span class=nc>Platform.Scheduler</span>

<span class=kr>type</span> <span class=kr>alias</span> <span class=kt>Task</span> <span class=nv>err</span> <span class=nv>ok</span> <span class=nf>=</span>
    <span class=kt>Platform</span><span class=nf>.</span><span class=kt>Scheduler</span><span class=nf>.</span><span class=kt>Task</span> <span class=p>(</span><span class=kt>Result</span> <span class=nv>err</span> <span class=nv>ok</span><span class=p>)</span>
</code></pre></div><p>Brilliant!
Only there are two problems:</p><ol><li>This is a MAJOR api change according to <code>elm diff</code> as it considers type aliases to a type and that type as different.</li><li>When compiling effect managers the elm compiler checks the type of the special functions that an event manager must define.
It checks that the return type is <code>Platform.Task err ok</code>.
However, with the changes I tried above the return types of these special effect manager functions become <code>Platform.Scheduler.Task err ok</code>.
The compiler does not see that the special functions use a type alias from the <code>Platform</code> module as the canonicalisation performed by the compiler removes this information.</li></ol><p>The obvious solution is to move the type definition back into the <code>Platform</code> module.
Next time I will explain the issues I faced when trying to do just that.</p><hr><ul><li><b id=f1><a href=#a1>1</a></b> With this definition, the compiler can not provide any b to the code implementing elm&rsquo;s runtime.</li><li><b id=f2><a href=#a2>2</a></b> Maybe that iteration will be the subject of a future post.</li></ul></article><ul class="pager blog-pager"><li class=next><a href=https://harrysarson.github.io/blog/posts/an-elm-runtime-in-elm/ data-toggle=tooltip data-placement=top title="An Elm Runtime in Elm">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2020
&nbsp;&bull;&nbsp;
<a href=https://harrysarson.github.io/blog/>Harry Sarson's Thoughts</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.71.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://harrysarson.github.io/blog/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://harrysarson.github.io/blog/js/load-photoswipe.js></script></body></html>